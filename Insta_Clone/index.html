<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatter ‚Äî Minimal Social Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121735;
      --muted: #93a5fd;
      --text: #e8eeff;
      --accent: #6c7cff;
      --accent-2: #16db65;
      --danger: #ff5c7a;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: linear-gradient(120deg, #0b1020, #141a3f);
      color: var(--text);
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh
    }

    .sidebar {
      background: rgba(18, 23, 53, .7);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border-right: 1px solid rgba(255, 255, 255, .08);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700
    }

    .logo .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-2);
      box-shadow: 0 0 18px var(--accent-2)
    }

    .card {
      background: rgba(255, 255, 255, .04);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 16px
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px
    }

    .user-card img {
      width: 36px;
      height: 36px;
      border-radius: 50%
    }

    .btn,
    button,
    input,
    textarea {
      font-family: inherit
    }

    .btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .15);
      background: rgba(255, 255, 255, .05);
      color: var(--text);
      cursor: pointer
    }

    .btn.primary {
      background: var(--accent);
      border-color: transparent
    }

    .btn.ghost {
      background: transparent;
      border-color: rgba(255, 255, 255, .1)
    }

    .btn.full {
      width: 100%
    }

    .muted {
      color: #a8b0d6;
      font-size: .9rem
    }

    .search {
      display: flex;
      gap: 8px;
      padding: 10px
    }

    .search input {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .2);
      color: var(--text)
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px
    }

    .nav .item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer
    }

    .nav .item.active,
    .nav .item:hover {
      background: rgba(255, 255, 255, .08)
    }

    .chats {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px;
      overflow: auto
    }

    .chat-row {
      display: grid;
      grid-template-columns: 46px 1fr auto;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      cursor: pointer
    }

    .chat-row:hover {
      background: rgba(255, 255, 255, .06)
    }

    .chat-row img {
      width: 46px;
      height: 46px;
      border-radius: 50%
    }

    .chat-row .name {
      font-weight: 600
    }

    .chat-row .last {
      color: #b7bde3;
      font-size: .92rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .main {
      display: flex;
      flex-direction: column;
      height: 100vh
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      background: rgba(18, 23, 53, .6);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px)
    }

    .topbar .title {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .content {
      display: grid;
      grid-template-rows: 1fr auto;
      gap: 0;
      height: calc(100vh - 56px)
    }

    .messages {
      padding: 14px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 14px;
      line-height: 1.35
    }

    .me {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent), #8e99ff)
    }

    .you {
      align-self: flex-start;
      background: rgba(255, 255, 255, .08)
    }

    .composer {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(255, 255, 255, .08);
      background: rgba(0, 0, 0, .15)
    }

    .composer textarea {
      resize: none;
      height: 50px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .2);
      color: var(--text)
    }

    .auth {
      max-width: 420px;
      margin: 8vh auto;
      padding: 20px;
    }

    .auth .group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 8px 0
    }

    .auth input {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .2);
      color: var(--text)
    }

    .switch {
      margin-top: 6px;
      font-size: .95rem
    }

    .empty {
      display: grid;
      place-items: center;
      height: 100%;
      color: #aeb7e9
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .08);
      border: 1px dashed rgba(255, 255, 255, .18)
    }

    @media(max-width:980px) {
      .app {
        grid-template-columns: 1fr
      }

      .sidebar {
        position: fixed;
        z-index: 10;
        inset: 0 30% 0 0;
        transform: translateX(-100%);
        transition: .25s
      }

      .sidebar.open {
        transform: none
      }

      .topbar .menu {
        display: inline-block
      }

      .topbar .menu button {
        font-size: 20px
      }

      .topbar .title {
        gap: 8px
      }
    }

    @media(min-width:981px) {
      .topbar .menu {
        display: none
      }
    }
  </style>
</head>

<body>
  <div id="authView" class="auth card" hidden>
    <div class="logo" style="margin-bottom:12px"><span class="dot"></span> <span>Chatter</span></div>
    <h2 id="authTitle">Create account</h2>
    <div class="group"><label>Name</label><input id="nameInput" placeholder="Ada Lovelace" /></div>
    <div class="group"><label>Email</label><input id="emailInput" type="email" placeholder="ada@chatter.app" />
    </div>
    <div class="group"><label>Password</label><input id="passwordInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <div class="group"><button class="btn primary full" id="authSubmit">Sign up</button></div>
    <div class="group"><button class="btn full" id="googleBtn">Continue with Google</button></div>
    <div class="switch" id="authSwitch">Already have an account? <a href="#" id="toLogin">Sign in</a></div>
    <p class="muted" style="margin-top:8px">Fill your Firebase config in the script to run locally.</p>
  </div>

  <div id="appView" class="app" hidden>
    <aside class="sidebar" id="sidebar">
      <div class="logo"><span class="dot"></span><span>Chatter</span></div>
      <div class="card user-card">
        <img id="meAvatar" src="https://api.dicebear.com/9.x/thumbs/svg?seed=me" alt="me">
        <div>
          <div id="meName" style="font-weight:600">‚Äî</div>
          <div id="meEmail" class="muted">‚Äî</div>
        </div>
      </div>

      <div class="card search">
        <input id="userSearch" placeholder="Search users by name/email" />
        <button class="btn" id="inviteBtn">+</button>
      </div>

      <div class="nav card">
        <div class="item active" id="navChats">üí¨ Chats</div>
        <div class="item" id="navPeople">üë• People</div>
        <div class="item" id="navProfile">üôç Profile</div>
        <div class="item" id="navLogout">üö™ Logout</div>
      </div>

      <div class="card" style="padding:8px;">
        <div class="muted" style="padding:8px 8px 0">Recent chats</div>
        <div class="chats" id="recentList"></div>
      </div>

      <div class="muted" style="padding:8px;text-align:center">Built with Firebase</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <div class="menu"><button class="btn ghost" id="toggleSidebar">‚ò∞</button></div>
          <div><strong id="chatTitle">Welcome</strong>
            <div id="chatSub" class="muted" style="font-size:.9rem">Select a conversation or find people to
              start chatting.</div>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="messages" id="messages"></div>
        <div class="composer" id="composer" hidden>
          <textarea id="messageInput" placeholder="Type a message‚Ä¶"></textarea>
          <button class="btn primary" id="sendBtn">Send</button>
        </div>
        <div class="empty" id="emptyState">
          <div class="pill">No chat selected</div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    // === 1) Fill YOUR Firebase config here ===
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD_Z-VTsczXOlN_vZSVcRJxDr2vAs-lVTc",
      authDomain: "instagramclone-83277.firebaseapp.com",
      projectId: "instagramclone-83277",
      storageBucket: "instagramclone-83277.firebasestorage.app",
      messagingSenderId: "1021467938686",
      appId: "1:1021467938686:web:88224eb3f6a9da1b956d2f",
      measurementId: "G-45376P5CXH"
    };

    // === 2) Firebase SDKs (v10 modular) ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, getDocs, serverTimestamp, onSnapshot, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM refs
    const authView = document.getElementById('authView');
    const appView = document.getElementById('appView');
    const authTitle = document.getElementById('authTitle');
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const authSubmit = document.getElementById('authSubmit');
    const toLogin = document.getElementById('toLogin');
    const googleBtn = document.getElementById('googleBtn');

    const meName = document.getElementById('meName');
    const meEmail = document.getElementById('meEmail');
    const meAvatar = document.getElementById('meAvatar');

    const recentList = document.getElementById('recentList');
    const userSearch = document.getElementById('userSearch');
    const inviteBtn = document.getElementById('inviteBtn');
    const navLogout = document.getElementById('navLogout');
    const navChats = document.getElementById('navChats');
    const navPeople = document.getElementById('navPeople');
    const navProfile = document.getElementById('navProfile');

    const chatTitle = document.getElementById('chatTitle');
    const chatSub = document.getElementById('chatSub');
    const messagesEl = document.getElementById('messages');
    const composer = document.getElementById('composer');
    const emptyState = document.getElementById('emptyState');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const toggleSidebar = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');

    let isSignup = true;
    let activeChatId = null;
    let messagesUnsub = null; // real-time listener cleanup
    let currentView = 'chats'; // Track current view

    const provider = new GoogleAuthProvider();

    function setAuthMode(signup) {
      isSignup = signup;
      authTitle.textContent = signup ? 'Create account' : 'Welcome back';
      authSubmit.textContent = signup ? 'Sign up' : 'Sign in';
      nameInput.parentElement.style.display = signup ? 'flex' : 'none';
      document.getElementById('authSwitch').innerHTML = signup ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>' : "Don't have an account? <a href='#' id='toSignup'>Create one'</a>";
      document.getElementById('toLogin')?.addEventListener('click', e => { e.preventDefault(); setAuthMode(false) });
      document.getElementById('toSignup')?.addEventListener('click', e => { e.preventDefault(); setAuthMode(true) });
    }

    setAuthMode(true);

    googleBtn.addEventListener('click', async () => {
      try {
        const cred = await signInWithPopup(auth, provider);
        await ensureUserDoc(cred.user);
      } catch (e) { alert(e.message) }
    });

    authSubmit.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      try {
        if (isSignup) {
          const name = nameInput.value.trim() || email.split('@')[0];
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: name, photoURL: `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(name)}` });
          await ensureUserDoc(cred.user);
        } else {
          const cred = await signInWithEmailAndPassword(auth, email, pass);
          await ensureUserDoc(cred.user);
        }
      } catch (e) { alert(e.message) }
    });

    navLogout.addEventListener('click', () => signOut(auth));
    toggleSidebar.addEventListener('click', () => sidebar.classList.toggle('open'));

    // Navigation functionality
    navChats.addEventListener('click', () => switchView('chats'));
    navPeople.addEventListener('click', () => switchView('people'));
    navProfile.addEventListener('click', () => switchView('profile'));

    function switchView(view) {
      currentView = view;

      // Update active nav item
      document.querySelectorAll('.nav .item').forEach(item => item.classList.remove('active'));

      if (view === 'chats') {
        navChats.classList.add('active');
        chatTitle.textContent = 'Recent Chats';
        chatSub.textContent = 'Select a conversation to start chatting.';
        recentList.style.display = 'flex';
        userSearch.parentElement.style.display = 'flex';
        loadRecentChats(auth.currentUser?.uid);
        emptyState.innerHTML = '<div class="pill">No chat selected</div>';
        composer.hidden = true;
        emptyState.hidden = false;
      } else if (view === 'people') {
        navPeople.classList.add('active');
        chatTitle.textContent = 'Find People';
        chatSub.textContent = 'Search for people to start chatting with.';
        recentList.style.display = 'flex';
        userSearch.parentElement.style.display = 'flex';
        loadAllUsers();
        emptyState.innerHTML = '<div class="pill">Search for people above</div>';
        composer.hidden = true;
        emptyState.hidden = false;
      } else if (view === 'profile') {
        navProfile.classList.add('active');
        chatTitle.textContent = 'Your Profile';
        chatSub.textContent = 'Manage your account settings.';
        recentList.style.display = 'none';
        userSearch.parentElement.style.display = 'none';
        showProfileView();
        composer.hidden = true;
        emptyState.hidden = true;
      }
    }

    async function loadAllUsers() {
      const me = auth.currentUser;
      if (!me) {
        console.log('No authenticated user');
        return;
      }

      try {
        console.log('Loading all users...');
        const usersRef = collection(db, 'users');
        const qs = await getDocs(usersRef);

        console.log('Total users found:', qs.size);
        const allUsers = qs.docs.map(d => d.data());
        console.log('All users:', allUsers);

        const users = allUsers.filter(u => u.uid !== me.uid);
        console.log('Other users (excluding me):', users);

        if (users.length === 0) {
          recentList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #aeb7e9;">
                            <h3>No other users found</h3>
                            <p>To test the chat functionality:</p>
                            <ol style="text-align: left; margin: 10px 0;">
                                <li>Open an incognito/private browser window</li>
                                <li>Go to this same URL</li>
                                <li>Create a new account with different email</li>
                                <li>Both users will then see each other here</li>
                            </ol>
                            <button class="btn primary" onclick="createTestUsers()" style="margin-top: 10px;">Add Test Users</button>
                        </div>
                    `;
        } else {
          renderPeople(users);
        }
      } catch (error) {
        console.error('Error loading users:', error);
        recentList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--danger);">
                        Error loading users: ${error.message}
                    </div>
                `;
      }
    }

    function showProfileView() {
      const user = auth.currentUser;
      if (!user) return;

      messagesEl.innerHTML = `
                <div style="padding: 20px; max-width: 500px;">
                    <h2 style="margin-bottom: 20px;">Profile Settings</h2>
                    
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                        <img src="${user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`}" 
                             style="width: 80px; height: 80px; border-radius: 50%;" alt="Profile">
                        <div>
                            <h3 style="margin: 0;">${escapeHtml(user.displayName || 'Anonymous')}</h3>
                            <p style="margin: 5px 0; color: #aeb7e9;">${escapeHtml(user.email || '')}</p>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #aeb7e9;">Display Name</label>
                            <input type="text" id="profileName" value="${escapeHtml(user.displayName || '')}" 
                                   style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #aeb7e9;">Email</label>
                            <input type="email" value="${escapeHtml(user.email || '')}" disabled
                                   style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: #aeb7e9;">
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn primary" onclick="updateProfile()" style="flex: 1;">Update Profile</button>
                            <button class="btn" onclick="changePassword()" style="flex: 1;">Change Password</button>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <h3>Account Actions</h3>
                        <button class="btn" onclick="signOut(auth)" style="background: var(--danger); margin-top: 10px;">Sign Out</button>
                    </div>
                </div>
            `;
    }

    // Profile functions
    window.updateProfile = async function () {
      const user = auth.currentUser;
      if (!user) return;

      const newName = document.getElementById('profileName').value.trim();
      if (!newName) {
        alert('Please enter a valid name');
        return;
      }

      try {
        await updateProfile(user, {
          displayName: newName,
          photoURL: user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(newName)}`
        });

        // Update user document in Firestore
        await updateDoc(doc(db, 'users', user.uid), {
          name: newName,
          photoURL: user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(newName)}`
        });

        alert('Profile updated successfully!');
        meName.textContent = newName;
        showProfileView(); // Refresh the view
      } catch (error) {
        alert('Error updating profile: ' + error.message);
      }
    };

    window.changePassword = function () {
      const newPassword = prompt('Enter new password (minimum 6 characters):');
      if (!newPassword || newPassword.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
      }

      // Note: Changing password requires recent authentication
      alert('For security reasons, please sign out and sign in again, then try changing your password.');
    };

    // Function to create test users for demonstration
    window.createTestUsers = async function () {
      const me = auth.currentUser;
      if (!me) return;

      const testUsers = [
        { name: 'Alice Johnson', email: 'alice@example.com' },
        { name: 'Bob Smith', email: 'bob@example.com' },
        { name: 'Carol Davis', email: 'carol@example.com' },
        { name: 'David Wilson', email: 'david@example.com' }
      ];

      try {
        console.log('Creating test user documents...');
        for (const testUser of testUsers) {
          const fakeUid = `test_${testUser.email.split('@')[0]}`;
          await setDoc(doc(db, 'users', fakeUid), {
            uid: fakeUid,
            name: testUser.name,
            email: testUser.email,
            photoURL: `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(testUser.name)}`,
            createdAt: serverTimestamp(),
            isTestUser: true
          });
        }
        alert('Test users created! Refresh the People section to see them.');
        loadAllUsers(); // Refresh the list
      } catch (error) {
        console.error('Error creating test users:', error);
        alert('Error creating test users: ' + error.message);
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authView.hidden = true; appView.hidden = false;
        meName.textContent = user.displayName || 'Anonymous';
        meEmail.textContent = user.email || '';
        meAvatar.src = user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`;

        // Initialize with chats view
        switchView('chats');
      } else {
        appView.hidden = true; authView.hidden = false; setAuthMode(false);
      }
    });

    async function ensureUserDoc(user) {
      const ref = doc(db, 'users', user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          uid: user.uid,
          name: user.displayName || user.email?.split('@')[0] || 'Anonymous',
          email: user.email,
          photoURL: user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`,
          createdAt: serverTimestamp()
        });
        console.log('User document created for:', user.email);
      } else {
        // Update existing user document with latest info
        await setDoc(ref, {
          uid: user.uid,
          name: user.displayName || user.email?.split('@')[0] || 'Anonymous',
          email: user.email,
          photoURL: user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`,
        }, { merge: true });
        console.log('User document updated for:', user.email);
      }
    }

    // Search & people listing
    userSearch.addEventListener('input', debounce(async (e) => {
      const term = e.target.value.trim().toLowerCase();
      const me = auth.currentUser;
      if (!me) return;

      const usersRef = collection(db, 'users');
      let users = [];

      if (term) {
        // Simple client filter because Firestore doesn't do contains for strings without indexes; keep demo-friendly
        const qs = await getDocs(usersRef);
        users = qs.docs.map(d => d.data()).filter(u =>
          u.uid !== me.uid &&
          ((u.name || '').toLowerCase().includes(term) ||
            (u.email || '').toLowerCase().includes(term))
        );
      } else if (currentView === 'people') {
        // Load all users when in people view and search is empty
        const qs = await getDocs(usersRef);
        users = qs.docs.map(d => d.data()).filter(u => u.uid !== me.uid).slice(0, 50);
      } else {
        // Clear results if not in people view
        renderPeople([]);
        return;
      }

      renderPeople(users);
    }, 300));

    function renderPeople(users) {
      recentList.innerHTML = ''; // Clear existing content

      if (users.length === 0) {
        recentList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #aeb7e9;">
                        <p>No users found</p>
                        <small>Search above or create test users to get started</small>
                    </div>
                `;
        return;
      }

      console.log('Rendering people:', users);
      users.forEach(u => {
        const row = document.createElement('div');
        row.className = 'chat-row';
        row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
        row.innerHTML = `
                    <img src="${u.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(u.name || u.uid)}`}" 
                         style="width: 46px; height: 46px; border-radius: 50%;">
                    <div style="flex: 1;">
                        <div class='name' style="font-weight: 600; color: white;">
                            ${escapeHtml(u.name || 'User')}
                            ${u.isTestUser ? '<span style="color: #6c7cff; font-size: 12px;">(Test User)</span>' : ''}
                        </div>
                        <div class='last' style="color: #aeb7e9; font-size: 14px;">${escapeHtml(u.email || '')}</div>
                    </div>
                    <div>
                        <button class='btn primary' onclick="startChatWithUser('${u.uid}')" 
                                style="padding: 8px 16px; font-size: 14px;">
                            üí¨ Chat
                        </button>
                    </div>
                `;
        recentList.appendChild(row);
      });
    }

    // Global function to start chat (accessible from onclick)
    window.startChatWithUser = function (otherUid) {
      console.log('Starting chat with user:', otherUid);
      startChatWith(otherUid);
    };

    // Recent chats (userChats subcollection per user for quick listing)
    function loadRecentChats(uid) {
      if (!uid) return;
      const ucRef = collection(db, 'userChats', uid, 'items');
      const qy = query(ucRef, orderBy('updatedAt', 'desc'));
      onSnapshot(qy, (qs) => {
        if (currentView !== 'chats') return; // Only update if in chats view

        recentList.innerHTML = '';
        if (qs.empty) {
          recentList.innerHTML = '<div style="padding: 20px; text-align: center; color: #aeb7e9;">No conversations yet.<br>Search for people to start chatting!</div>';
          return;
        }

        qs.forEach(docu => {
          const c = docu.data();
          const row = document.createElement('div');
          row.className = 'chat-row';
          row.dataset.chatId = c.chatId;
          row.innerHTML = `
          <img src="${c.otherPhoto || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(c.otherUid)}`}" alt="pfp">
          <div><div class="name">${escapeHtml(c.otherName || 'User')}</div><div class="last">${escapeHtml(c.lastMessage || 'Say hi üëã')}</div></div>
          <div class="muted">${timeAgo(c.updatedAt?.toDate?.() || new Date())}</div>`;
          row.addEventListener('click', () => openChat(c.chatId, { uid: c.otherUid, name: c.otherName, photo: c.otherPhoto }));
          recentList.appendChild(row);
        });
      });
    }

    function composeChatId(a, b) { return a < b ? `${a}_${b}` : `${b}_${a}` }

    async function startChatWith(otherUid) {
      const me = auth.currentUser;
      if (!me || me.uid === otherUid) return;

      try {
        const chatId = composeChatId(me.uid, otherUid);
        const chatRef = doc(db, 'chats', chatId);
        const chatSnap = await getDoc(chatRef);
        if (!chatSnap.exists()) {
          // Create chat doc
          await setDoc(chatRef, { chatId, participants: [me.uid, otherUid], createdAt: serverTimestamp(), updatedAt: serverTimestamp(), lastMessage: '' });
        }

        // Mirror in each user's userChats for fast recent list
        const other = await getDoc(doc(db, 'users', otherUid));
        const meUser = await getDoc(doc(db, 'users', me.uid));

        if (!other.exists()) {
          alert('User not found');
          return;
        }

        await setDoc(doc(db, 'userChats', me.uid, 'items', chatId), {
          chatId, otherUid, otherName: other.data()?.name || 'User', otherPhoto: other.data()?.photoURL || '', lastMessage: '', updatedAt: serverTimestamp()
        }, { merge: true });
        await setDoc(doc(db, 'userChats', otherUid, 'items', chatId), {
          chatId, otherUid: me.uid, otherName: meUser.data()?.name || 'User', otherPhoto: meUser.data()?.photoURL || '', lastMessage: '', updatedAt: serverTimestamp()
        }, { merge: true });

        // Switch to chats view and open the conversation
        switchView('chats');
        setTimeout(() => {
          openChat(chatId, { uid: otherUid, name: other.data()?.name, photo: other.data()?.photoURL });
        }, 500);
      } catch (error) {
        console.error('Error starting chat:', error);
        alert('Error starting chat: ' + error.message);
      }
    }

    function openChat(chatId, other) {
      activeChatId = chatId;
      chatTitle.textContent = other?.name || 'Chat';
      chatSub.textContent = other?.email || 'Click to view profile';
      emptyState.hidden = true;
      composer.hidden = false;
      messagesEl.innerHTML = '';
      sidebar.classList.remove('open');

      if (messagesUnsub) messagesUnsub();
      const msgsRef = collection(db, 'chats', chatId, 'messages');
      const qy = query(msgsRef, orderBy('createdAt', 'asc'));
      messagesUnsub = onSnapshot(qy, (qs) => {
        messagesEl.innerHTML = '';
        if (qs.empty) {
          messagesEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #aeb7e9;">Start the conversation by sending a message! üëã</div>';
        } else {
          qs.forEach(d => {
            const m = d.data();
            const isMe = m.senderId === auth.currentUser?.uid;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'me' : 'you'}`;
            div.textContent = m.text;

            // Add timestamp on hover
            if (m.createdAt) {
              div.title = m.createdAt.toDate().toLocaleString();
            }

            messagesEl.appendChild(div);
          });
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, (error) => {
        console.error('Error loading messages:', error);
        messagesEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">Error loading messages. Please try again.</div>';
      });
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !activeChatId) return;
      const me = auth.currentUser; if (!me) return;
      messageInput.value = '';
      const msgsRef = collection(db, 'chats', activeChatId, 'messages');
      await addDoc(msgsRef, { text, senderId: me.uid, createdAt: serverTimestamp() });
      // update last message mirrors
      const chatRef = doc(db, 'chats', activeChatId);
      await updateDoc(chatRef, { lastMessage: text, updatedAt: serverTimestamp() });

      // Determine other userId from chatId
      const [a, b] = activeChatId.split('_');
      const otherUid = me.uid === a ? b : a;
      await updateDoc(doc(db, 'userChats', me.uid, 'items', activeChatId), { lastMessage: text, updatedAt: serverTimestamp() });
      await updateDoc(doc(db, 'userChats', otherUid, 'items', activeChatId), { lastMessage: text, updatedAt: serverTimestamp() });
    }

    // Helpers
    function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms) } }
    function escapeHtml(s) { return s?.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c])) }
    function timeAgo(date) { const d = (typeof date === 'number') ? new Date(date) : date; const diff = Math.floor((Date.now() - d.getTime()) / 1000); if (diff < 60) return diff + "s"; if (diff < 3600) return Math.floor(diff / 60) + "m"; if (diff < 86400) return Math.floor(diff / 3600) + "h"; return Math.floor(diff / 86400) + "d" }

    // Invite button simply opens mailto with this page URL (when hosted)
    inviteBtn.addEventListener('click', () => {
      const url = location.href;
      location.href = `mailto:?subject=Join me on Chatter&body=Let‚Äôs chat here: ${url}`;
    });
  </script>
</body>

</html>